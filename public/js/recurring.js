// Recurring Compliance Page
class RecurringPage {
    constructor() {
        this.recurringRules = [];
        this.tasks = [];
        this.clients = [];
        this.services = [];
        this.selectedRule = null;
    }

    async render() {
        const pageContent = document.getElementById('pageContent');
        
        try {
            // Load all required data
            const [rules, tasks, clients, services] = await Promise.all([
                api.getRecurringRules(),
                api.getTasks(),
                api.getClients(),
                api.getServices()
            ]);
            
            this.recurringRules = rules;
            this.tasks = tasks;
            this.clients = clients;
            this.services = services;
            
            pageContent.innerHTML = `
                <div class="recurring-header">
                    <h2>Recurring Compliance Management</h2>
                    <button class="btn btn-primary" onclick="recurringPage.showAddRuleModal()">
                        <i class="fas fa-plus"></i>
                        Add Recurring Rule
                    </button>
                </div>
                
                <div class="recurring-content">
                    <div class="rules-section">
                        <div class="section-header">
                            <h3>Compliance Rules</h3>
                            <div class="section-actions">
                                <button class="btn btn-outline" onclick="recurringPage.refreshData()">
                                    <i class="fas fa-refresh"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="rules-grid" id="rulesGrid">
                            ${this.renderRulesGrid()}
                        </div>
                    </div>
                    
                    <div class="auto-tasks-section">
                        <div class="section-header">
                            <h3>Auto-Generated Tasks</h3>
                            <select class="form-control" id="taskRuleFilter" onchange="recurringPage.filterTasks()">
                                <option value="">All Rules</option>
                                ${this.recurringRules.map(rule => 
                                    `<option value="${rule.id}">${rule.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="tasks-list" id="autoTasksList">
                            ${this.renderAutoGeneratedTasks()}
                        </div>
                    </div>
                </div>
                
                <style>
                    .recurring-content {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 24px;
                        margin-top: 24px;
                    }
                    
                    .section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 16px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid var(--border-color);
                    }
                    
                    .section-header h3 {
                        font-size: 18px;
                        font-weight: 600;
                        color: var(--dark-text);
                        margin: 0;
                    }
                    
                    .section-actions {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    }
                    
                    .rules-grid {
                        display: grid;
                        gap: 16px;
                    }
                    
                    .rule-card {
                        background: var(--white);
                        border: 1px solid var(--border-color);
                        border-radius: var(--border-radius);
                        padding: 20px;
                        transition: all 0.2s ease;
                    }
                    
                    .rule-card:hover {
                        border-color: var(--primary-color);
                        box-shadow: var(--shadow-md);
                    }
                    
                    .rule-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 12px;
                    }
                    
                    .rule-title {
                        font-size: 16px;
                        font-weight: 600;
                        color: var(--dark-text);
                        margin-bottom: 4px;
                    }
                    
                    .rule-status {
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: 500;
                        text-transform: uppercase;
                    }
                    
                    .rule-status.active {
                        background: var(--success-light);
                        color: var(--success-color);
                    }
                    
                    .rule-status.inactive {
                        background: var(--error-light);
                        color: var(--error-color);
                    }
                    
                    .rule-details {
                        color: var(--muted-text);
                        font-size: 14px;
                        margin-bottom: 12px;
                        line-height: 1.4;
                    }
                    
                    .rule-schedule {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 16px;
                        padding: 8px 12px;
                        background: var(--background-light);
                        border-radius: 6px;
                    }
                    
                    .rule-schedule i {
                        color: var(--primary-color);
                    }
                    
                    .rule-actions {
                        display: flex;
                        gap: 8px;
                    }
                    
                    .tasks-list {
                        max-height: 500px;
                        overflow-y: auto;
                    }
                    
                    .task-item {
                        background: var(--white);
                        border: 1px solid var(--border-color);
                        border-radius: var(--border-radius);
                        padding: 16px;
                        margin-bottom: 8px;
                        transition: all 0.2s ease;
                    }
                    
                    .task-item:hover {
                        border-color: var(--primary-color);
                    }
                    
                    .task-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                    }
                    
                    .task-title {
                        font-weight: 500;
                        color: var(--dark-text);
                    }
                    
                    .task-status {
                        padding: 2px 6px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 500;
                        text-transform: uppercase;
                    }
                    
                    .task-info {
                        display: flex;
                        gap: 16px;
                        font-size: 13px;
                        color: var(--muted-text);
                    }
                    
                    .task-info span {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    
                    @media (max-width: 768px) {
                        .recurring-content {
                            grid-template-columns: 1fr;
                        }
                    }
                </style>
            `;

            // Store reference for global access
            window.recurringPage = this;
            
        } catch (error) {
            pageContent.innerHTML = `<div class="alert alert-error">Error loading recurring rules: ${error.message}</div>`;
        }
    }

    renderRulesGrid() {
        if (this.recurringRules.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-calendar-check"></i>
                    <h3>No Recurring Rules</h3>
                    <p>Create your first recurring compliance rule to automate task generation.</p>
                </div>
            `;
        }

        return this.recurringRules.map(rule => {
            const client = this.clients.find(c => c.id === rule.client_id);
            const service = this.services.find(s => s.id === rule.service_id);
            
            return `
                <div class="rule-card">
                    <div class="rule-header">
                        <div>
                            <div class="rule-title">${rule.title}</div>
                            <div class="rule-details">${rule.description || 'No description'}</div>
                        </div>
                        <span class="rule-status ${rule.active ? 'active' : 'inactive'}">
                            ${rule.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    
                    <div class="rule-schedule">
                        <i class="fas fa-clock"></i>
                        <span>${this.formatFrequency(rule.frequency, rule.frequency_value)}</span>
                    </div>
                    
                    <div class="rule-details">
                        <div><strong>Client:</strong> ${client ? client.name : 'All Clients'}</div>
                        <div><strong>Service:</strong> ${service ? service.name : 'General'}</div>
                        <div><strong>Next Due:</strong> ${rule.next_due_date || 'Not scheduled'}</div>
                    </div>
                    
                    <div class="rule-actions">
                        <button class="btn btn-sm btn-outline" onclick="recurringPage.editRule(${rule.id})">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="recurringPage.toggleRuleStatus(${rule.id})">
                            <i class="fas fa-${rule.active ? 'pause' : 'play'}"></i>
                            ${rule.active ? 'Pause' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="recurringPage.deleteRule(${rule.id})">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    renderAutoGeneratedTasks() {
        // Filter tasks that were generated from recurring rules
        const autoTasks = this.tasks.filter(task => task.recurring_rule_id);
        
        if (autoTasks.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-robot"></i>
                    <h3>No Auto-Generated Tasks</h3>
                    <p>Tasks will appear here when generated from recurring rules.</p>
                </div>
            `;
        }

        return autoTasks.map(task => {
            const client = this.clients.find(c => c.id === task.client_id);
            const rule = this.recurringRules.find(r => r.id === task.recurring_rule_id);
            
            return `
                <div class="task-item">
                    <div class="task-header">
                        <div class="task-title">${task.title}</div>
                        <span class="task-status status-${task.status}">${task.status.replace('_', ' ')}</span>
                    </div>
                    <div class="task-info">
                        <span><i class="fas fa-user"></i> ${client ? client.name : 'No Client'}</span>
                        <span><i class="fas fa-calendar"></i> ${task.due_date || 'No due date'}</span>
                        <span><i class="fas fa-sync"></i> ${rule ? rule.title : 'Unknown Rule'}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    formatFrequency(frequency, value) {
        const frequencies = {
            daily: `Every ${value} day(s)`,
            weekly: `Every ${value} week(s)`,
            monthly: `Every ${value} month(s)`,
            quarterly: `Every ${value} quarter(s)`,
            yearly: `Every ${value} year(s)`
        };
        
        return frequencies[frequency] || `${frequency} - ${value}`;
    }

    async refreshData() {
        try {
            showLoading();
            const [rules, tasks] = await Promise.all([
                api.getRecurringRules(),
                api.getTasks()
            ]);
            
            this.recurringRules = rules;
            this.tasks = tasks;
            
            document.getElementById('rulesGrid').innerHTML = this.renderRulesGrid();
            document.getElementById('autoTasksList').innerHTML = this.renderAutoGeneratedTasks();
            
            hideLoading();
            showToast('Data refreshed successfully', 'success');
        } catch (error) {
            hideLoading();
            showToast('Failed to refresh data: ' + error.message, 'error');
        }
    }

    filterTasks() {
        const ruleId = document.getElementById('taskRuleFilter').value;
        const filteredTasks = ruleId ? 
            this.tasks.filter(task => task.recurring_rule_id == ruleId) : 
            this.tasks.filter(task => task.recurring_rule_id);
        
        // Update the tasks list with filtered data
        const tasksHtml = filteredTasks.length === 0 ? 
            `<div class="empty-state">
                <i class="fas fa-filter"></i>
                <h3>No Tasks Found</h3>
                <p>No auto-generated tasks match the selected filter.</p>
            </div>` :
            filteredTasks.map(task => {
                const client = this.clients.find(c => c.id === task.client_id);
                const rule = this.recurringRules.find(r => r.id === task.recurring_rule_id);
                
                return `
                    <div class="task-item">
                        <div class="task-header">
                            <div class="task-title">${task.title}</div>
                            <span class="task-status status-${task.status}">${task.status.replace('_', ' ')}</span>
                        </div>
                        <div class="task-info">
                            <span><i class="fas fa-user"></i> ${client ? client.name : 'No Client'}</span>
                            <span><i class="fas fa-calendar"></i> ${task.due_date || 'No due date'}</span>
                            <span><i class="fas fa-sync"></i> ${rule ? rule.title : 'Unknown Rule'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        
        document.getElementById('autoTasksList').innerHTML = tasksHtml;
    }

    showAddRuleModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Add Recurring Rule</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <form id="addRuleForm">
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" name="title" required class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>Description</label>
                                <textarea name="description" class="form-control" rows="2"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Client</label>
                                <select name="client_id" class="form-control">
                                    <option value="">All Clients</option>
                                    ${this.clients.map(client => 
                                        `<option value="${client.id}">${client.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Service</label>
                                <select name="service_id" class="form-control">
                                    <option value="">General</option>
                                    ${this.services.map(service => 
                                        `<option value="${service.id}">${service.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Frequency *</label>
                                <select name="frequency" required class="form-control">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="daily">Daily</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Frequency Value *</label>
                                <input type="number" name="frequency_value" value="1" min="1" required class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>Start Date *</label>
                                <input type="date" name="start_date" required class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" name="end_date" class="form-control">
                            </div>
                            
                            <div class="form-group full-width">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="active" checked>
                                    <span class="checkmark"></span>
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Rule</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('addRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.handleAddRule(e);
        });
    }

    async handleAddRule(e) {
        try {
            showLoading();
            
            const formData = new FormData(e.target);
            const ruleData = {
                title: formData.get('title'),
                description: formData.get('description'),
                client_id: formData.get('client_id') || null,
                service_id: formData.get('service_id') || null,
                frequency: formData.get('frequency'),
                frequency_value: parseInt(formData.get('frequency_value')),
                start_date: formData.get('start_date'),
                end_date: formData.get('end_date') || null,
                active: formData.has('active')
            };
            
            await api.createRecurringRule(ruleData);
            
            hideLoading();
            e.target.closest('.modal').remove();
            showToast('Recurring rule added successfully', 'success');
            
            await this.refreshData();
        } catch (error) {
            hideLoading();
            showToast('Failed to add rule: ' + error.message, 'error');
        }
    }

    async editRule(id) {
        const rule = this.recurringRules.find(r => r.id === id);
        if (!rule) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Recurring Rule</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <form id="editRuleForm">
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" name="title" value="${rule.title}" required class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>Description</label>
                                <textarea name="description" class="form-control" rows="2">${rule.description || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Client</label>
                                <select name="client_id" class="form-control">
                                    <option value="">All Clients</option>
                                    ${this.clients.map(client => 
                                        `<option value="${client.id}" ${client.id == rule.client_id ? 'selected' : ''}>${client.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Service</label>
                                <select name="service_id" class="form-control">
                                    <option value="">General</option>
                                    ${this.services.map(service => 
                                        `<option value="${service.id}" ${service.id == rule.service_id ? 'selected' : ''}>${service.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Frequency *</label>
                                <select name="frequency" required class="form-control">
                                    <option value="monthly" ${rule.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="quarterly" ${rule.frequency === 'quarterly' ? 'selected' : ''}>Quarterly</option>
                                    <option value="yearly" ${rule.frequency === 'yearly' ? 'selected' : ''}>Yearly</option>
                                    <option value="weekly" ${rule.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                    <option value="daily" ${rule.frequency === 'daily' ? 'selected' : ''}>Daily</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Frequency Value *</label>
                                <input type="number" name="frequency_value" value="${rule.frequency_value}" min="1" required class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>Start Date *</label>
                                <input type="date" name="start_date" value="${rule.start_date}" required class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" name="end_date" value="${rule.end_date || ''}" class="form-control">
                            </div>
                            
                            <div class="form-group full-width">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="active" ${rule.active ? 'checked' : ''}>
                                    <span class="checkmark"></span>
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Rule</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('editRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.handleEditRule(e, id);
        });
    }

    async handleEditRule(e, id) {
        try {
            showLoading();
            
            const formData = new FormData(e.target);
            const ruleData = {
                title: formData.get('title'),
                description: formData.get('description'),
                client_id: formData.get('client_id') || null,
                service_id: formData.get('service_id') || null,
                frequency: formData.get('frequency'),
                frequency_value: parseInt(formData.get('frequency_value')),
                start_date: formData.get('start_date'),
                end_date: formData.get('end_date') || null,
                active: formData.has('active')
            };
            
            await api.updateRecurringRule(id, ruleData);
            
            hideLoading();
            e.target.closest('.modal').remove();
            showToast('Recurring rule updated successfully', 'success');
            
            await this.refreshData();
        } catch (error) {
            hideLoading();
            showToast('Failed to update rule: ' + error.message, 'error');
        }
    }

    async toggleRuleStatus(id) {
        const rule = this.recurringRules.find(r => r.id === id);
        if (!rule) return;
        
        try {
            showLoading();
            await api.updateRecurringRule(id, { active: !rule.active });
            hideLoading();
            showToast(`Rule ${rule.active ? 'paused' : 'activated'} successfully`, 'success');
            await this.refreshData();
        } catch (error) {
            hideLoading();
            showToast('Failed to update rule status: ' + error.message, 'error');
        }
    }

    async deleteRule(id) {
        if (!confirm('Are you sure you want to delete this recurring rule? This action cannot be undone.')) {
            return;
        }
        
        try {
            showLoading();
            await api.deleteRecurringRule(id);
            hideLoading();
            showToast('Recurring rule deleted successfully', 'success');
            await this.refreshData();
        } catch (error) {
            hideLoading();
            showToast('Failed to delete rule: ' + error.message, 'error');
        }
    }
}